---
import galleryData from '../../data/gallery.json';

const base = import.meta.env.BASE_URL;

export function getStaticPaths() {
  return galleryData.map((item) => ({
    params: { id: item.object.id },
    props: { item },
  }));
}

const { item } = Astro.props;
const object = item.object;
const session = item.session;
---

<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{object.name} - Astro Gallery</title>
    <meta name="description" content={object.description} />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        margin: 0;
        padding: 0;
        background: #000;
        color: #e0e0e0;
        line-height: 1.6;
      }

      /* Navigation */
      .nav {
        position: sticky;
        top: 0;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #222;
        z-index: 100;
        padding: 1rem;
      }

      .nav-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .back-link {
        color: #888;
        text-decoration: none;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: color 0.2s;
      }

      .back-link:hover {
        color: #fff;
      }

      /* Hero Section */
      .hero {
        position: relative;
        width: 100%;
        max-height: 70vh;
        overflow: hidden;
        background: #111;
      }

      .hero-image {
        width: 100%;
        height: 70vh;
        display: block;
        cursor: pointer;
        transition: opacity 0.3s;
        object-fit: cover;
        object-position: center;
      }

      .hero-image:hover {
        opacity: 0.9;
      }

      .hero-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
        padding: 2rem 1.5rem 1.5rem;
      }

      .hero-title {
        font-size: 2rem;
        font-weight: 500;
        margin: 0 0 0.5rem 0;
        color: #fff;
      }

      .hero-subtitle {
        font-size: 1rem;
        color: #aaa;
        margin: 0;
      }

      @media (min-width: 768px) {
        .hero-overlay {
          padding: 3rem 2rem 2rem;
        }

        .hero-title {
          font-size: 2.5rem;
        }

        .hero-subtitle {
          font-size: 1.1rem;
        }
      }

      /* Content Layout */
      .content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      @media (min-width: 1024px) {
        .content {
          grid-template-columns: 2fr 1fr;
          padding: 3rem 2rem;
          gap: 3rem;
        }
      }

      /* Main Content */
      .main-content {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      /* Section Styles */
      .section {
        background: #111;
        border: 1px solid #222;
        padding: 1.5rem;
      }

      @media (min-width: 768px) {
        .section {
          padding: 2rem;
        }
      }

      .section-title {
        font-size: 1.3rem;
        font-weight: 500;
        margin: 0 0 1rem 0;
        color: #fff;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #222;
      }

      .section-content {
        font-size: 0.95rem;
        color: #ccc;
        line-height: 1.8;
      }

      /* Meta Grid */
      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .meta-item {
        background: #0a0a0a;
        padding: 1rem;
        border-left: 2px solid #333;
      }

      .meta-label {
        display: block;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #666;
        margin-bottom: 0.5rem;
      }

      .meta-value {
        font-size: 0.95rem;
        color: #fff;
        font-weight: 400;
      }

      /* Tech Details Grid */
      .tech-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      @media (min-width: 640px) {
        .tech-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .tech-item {
        padding: 1rem;
        background: #0a0a0a;
        border-left: 2px solid #333;
      }

      .tech-label {
        display: block;
        color: #666;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
      }

      .tech-value {
        color: #ccc;
        font-size: 0.9rem;
      }

      /* Sidebar */
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      /* Quick Facts */
      .quick-facts {
        background: #111;
        border: 1px solid #222;
        padding: 1.5rem;
      }

      .fact-item {
        padding: 1rem 0;
        border-bottom: 1px solid #1a1a1a;
      }

      .fact-item:last-child {
        border-bottom: none;
      }

      .fact-label {
        font-size: 0.75rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
      }

      .fact-value {
        font-size: 1.1rem;
        color: #fff;
        font-weight: 500;
      }

      /* Aliases */
      .aliases {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .alias-badge {
        background: #1a1a1a;
        padding: 0.3rem 0.7rem;
        font-size: 0.8rem;
        color: #999;
        border: 1px solid #222;
      }

      /* Lightbox */
      .lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        overflow: hidden;
      }

      .lightbox.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lightbox-content {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        touch-action: none;
      }

      .lightbox-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.2s ease-out;
        cursor: grab;
      }

      .lightbox-image.dragging {
        cursor: grabbing;
        transition: none;
      }

      .lightbox-close {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        font-size: 32px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        z-index: 10000;
      }

      .lightbox-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .lightbox-zoom-info {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 14px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .lightbox-zoom-info.show {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <nav class="nav">
      <div class="nav-content">
        <a href={`${base}/`} class="back-link">
          <span>←</span>
          <span>Назад до галереї</span>
        </a>
      </div>
    </nav>

    <section class="hero">
      {item.preview && (
        <img
          src={`${base}/${item.preview.replace('_800', '_2000')}`}
          alt={object.name}
          class="hero-image"
          id="hero-image"
          data-full={`${base}/${item.final}`}
        />
      )}
      <div class="hero-overlay">
        <h1 class="hero-title">{object.name}</h1>
        <p class="hero-subtitle">{object.type} у сузір'ї {object.constellation}</p>
      </div>
    </section>

    <div class="content">
      <div class="main-content">
        <div class="section">
          <h2 class="section-title">Про об'єкт</h2>
          <div class="section-content">
            <p>{object.description}</p>
          </div>
        </div>

        {object.extended_description && (
          <div class="section">
            <h2 class="section-title">Детальніше</h2>
            <div class="section-content">
              <p>{object.extended_description}</p>
            </div>
          </div>
        )}

        <div class="section">
          <h2 class="section-title">Обладнання</h2>
          <div class="tech-grid">
            {session?.camera && (
              <div class="tech-item">
                <span class="tech-label">Камера</span>
                <div class="tech-value">{session.camera}</div>
              </div>
            )}
            {session?.telescope && (
              <div class="tech-item">
                <span class="tech-label">Телескоп</span>
                <div class="tech-value">{session.telescope}</div>
              </div>
            )}
            {session?.coma_corrector && (
              <div class="tech-item">
                <span class="tech-label">Комакоректор</span>
                <div class="tech-value">{session.coma_corrector}</div>
              </div>
            )}
            {session?.mount && (
              <div class="tech-item">
                <span class="tech-label">Монтування</span>
                <div class="tech-value">{session.mount}</div>
              </div>
            )}
            {session?.filters && session.filters.length > 0 && (
              <div class="tech-item">
                <span class="tech-label">Фільтри</span>
                <div class="tech-value">{session.filters.join(', ')}</div>
              </div>
            )}
            {session?.guiding && (
              <div class="tech-item">
                <span class="tech-label">Гідування</span>
                <div class="tech-value">
                  {session.guiding.camera && `${session.guiding.camera} / `}
                  {session.guiding.software}
                  {session.guiding.rms_arcsec && session.guiding.rms_arcsec !== null && ` (RMS ${session.guiding.rms_arcsec}")`}
                </div>
              </div>
            )}
            {session?.bortle && (
              <div class="tech-item">
                <span class="tech-label">Bortle Scale</span>
                <div class="tech-value">{session.bortle}</div>
              </div>
            )}
          </div>
        </div>

        {session?.subs && session.subs.length > 0 && (
          <div class="section">
            <h2 class="section-title">Експозиції</h2>
            <div class="tech-grid">
              {session.subs.map((sub) => (
                <div class="tech-item">
                  <span class="tech-label">{sub.band}</span>
                  <div class="tech-value">
                    {sub.count} × {sub.exposure_s}s
                    {sub.iso && ` (ISO ${sub.iso})`}
                  </div>
                </div>
              ))}
              <div class="tech-item">
                <span class="tech-label">Загальний час</span>
                <div class="tech-value">
                  {Math.floor(session.subs.reduce((acc, sub) => acc + (sub.count * sub.exposure_s), 0) / 60)} хв
                  ({(session.subs.reduce((acc, sub) => acc + (sub.count * sub.exposure_s), 0) / 3600).toFixed(1)} год)
                </div>
              </div>
            </div>
          </div>
        )}

        {(session?.stacking_software || session?.processing_software) && (
          <div class="section">
            <h2 class="section-title">Обробка</h2>
            <div class="tech-grid">
              {session.stacking_software && (
                <div class="tech-item">
                  <span class="tech-label">Стекінг</span>
                  <div class="tech-value">{session.stacking_software}</div>
                </div>
              )}
              {session.processing_software && session.processing_software.length > 0 && (
                <div class="tech-item">
                  <span class="tech-label">Обробка</span>
                  <div class="tech-value">{session.processing_software.join(', ')}</div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      <aside class="sidebar">
        <div class="quick-facts">
          <h2 class="section-title">Швидкі факти</h2>

          <div class="fact-item">
            <div class="fact-label">Відстань</div>
            <div class="fact-value">
              {object.distance_ly.toLocaleString('uk-UA')} св.р.
            </div>
          </div>

          <div class="fact-item">
            <div class="fact-label">Сузір'я</div>
            <div class="fact-value">{object.constellation}</div>
          </div>

          <div class="fact-item">
            <div class="fact-label">Тип</div>
            <div class="fact-value">{object.type}</div>
          </div>

          {session?.date_utc && (
            <div class="fact-item">
              <div class="fact-label">Дата зйомки</div>
              <div class="fact-value">{session.date_utc}</div>
            </div>
          )}

          {session?.location && (
            <div class="fact-item">
              <div class="fact-label">Локація</div>
              <div class="fact-value">{session.location}</div>
            </div>
          )}

          {object.aliases && object.aliases.length > 0 && (
            <div class="fact-item">
              <div class="fact-label">Також відомий як</div>
              <div class="aliases">
                {object.aliases.map((alias) => (
                  <span class="alias-badge">{alias}</span>
                ))}
              </div>
            </div>
          )}
        </div>

        {(object.credits || object.license) && (
          <div class="quick-facts" style="margin-top: 1.5rem;">
            <h2 class="section-title">Авторські права</h2>
            {object.credits && (
              <div class="fact-item">
                <div class="fact-label">Автор</div>
                <div class="fact-value">{object.credits}</div>
              </div>
            )}
            {object.license && (
              <div class="fact-item">
                <div class="fact-label">Ліцензія</div>
                <div class="fact-value">{object.license}</div>
              </div>
            )}
          </div>
        )}
      </aside>
    </div>

    <!-- Lightbox Modal -->
    <div class="lightbox" id="lightbox">
      <button class="lightbox-close" id="lightbox-close">&times;</button>
      <div class="lightbox-content" id="lightbox-content">
        <img src="" alt="" class="lightbox-image" id="lightbox-image" />
      </div>
      <div class="lightbox-zoom-info" id="zoom-info">Колесико миші для zoom</div>
    </div>

    <script>
      // Lightbox functionality with zoom and pan
      const lightbox = document.getElementById('lightbox');
      const lightboxImage = document.getElementById('lightbox-image');
      const lightboxContent = document.getElementById('lightbox-content');
      const lightboxClose = document.getElementById('lightbox-close');
      const zoomInfo = document.getElementById('zoom-info');
      const heroImage = document.getElementById('hero-image');

      let scale = 1;
      let translateX = 0;
      let translateY = 0;
      let isDragging = false;
      let startX = 0;
      let startY = 0;
      let lastTouchDistance = 0;

      // Open lightbox
      if (heroImage) {
        heroImage.addEventListener('click', () => {
          const fullSrc = heroImage.dataset.full;
          const alt = heroImage.alt;

          lightboxImage.src = fullSrc;
          lightboxImage.alt = alt;
          lightbox.classList.add('active');
          document.body.style.overflow = 'hidden';

          // Show zoom info briefly
          zoomInfo.classList.add('show');
          setTimeout(() => zoomInfo.classList.remove('show'), 2000);

          // Reset transform
          scale = 1;
          translateX = 0;
          translateY = 0;
          updateTransform();
        });
      }

      // Close lightbox
      const closeLightbox = () => {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
        scale = 1;
        translateX = 0;
        translateY = 0;
        updateTransform();
      };

      lightboxClose.addEventListener('click', closeLightbox);

      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) {
          closeLightbox();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && lightbox.classList.contains('active')) {
          closeLightbox();
        }
      });

      // Update transform
      const updateTransform = () => {
        lightboxImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
      };

      // Mouse wheel zoom
      lightboxContent.addEventListener('wheel', (e) => {
        e.preventDefault();

        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        const newScale = Math.max(1, Math.min(5, scale + delta));

        if (newScale !== scale) {
          scale = newScale;

          if (scale === 1) {
            translateX = 0;
            translateY = 0;
          }

          updateTransform();
        }
      });

      // Mouse drag to pan
      lightboxImage.addEventListener('mousedown', (e) => {
        if (scale > 1) {
          isDragging = true;
          startX = e.clientX - translateX;
          startY = e.clientY - translateY;
          lightboxImage.classList.add('dragging');
        }
      });

      document.addEventListener('mousemove', (e) => {
        if (isDragging) {
          translateX = e.clientX - startX;
          translateY = e.clientY - startY;
          updateTransform();
        }
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        lightboxImage.classList.remove('dragging');
      });

      // Touch pinch-to-zoom
      lightboxContent.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          lastTouchDistance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );
        } else if (e.touches.length === 1 && scale > 1) {
          isDragging = true;
          startX = e.touches[0].clientX - translateX;
          startY = e.touches[0].clientY - translateY;
        }
      }, { passive: false });

      lightboxContent.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const currentDistance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );

          if (lastTouchDistance > 0) {
            const delta = (currentDistance - lastTouchDistance) * 0.01;
            const newScale = Math.max(1, Math.min(5, scale + delta));

            if (newScale !== scale) {
              scale = newScale;

              if (scale === 1) {
                translateX = 0;
                translateY = 0;
              }

              updateTransform();
            }
          }

          lastTouchDistance = currentDistance;
        } else if (e.touches.length === 1 && isDragging) {
          e.preventDefault();
          translateX = e.touches[0].clientX - startX;
          translateY = e.touches[0].clientY - startY;
          updateTransform();
        }
      }, { passive: false });

      lightboxContent.addEventListener('touchend', (e) => {
        if (e.touches.length === 0) {
          isDragging = false;
          lastTouchDistance = 0;
        }
      });
    </script>
  </body>
</html>
